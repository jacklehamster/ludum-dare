package{	import flash.utils.getTimer;	import flash.geom.Point;		import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.utils.getDefinitionByName;	import flash.system.Security;	import flash.events.Event;	import flash.events.IOErrorEvent;	import flash.net.URLVariables;//	import com.adobe.serialization.json.JSON;		public class MixoMap extends Map	{		var room:String = null;				function MixoMap(room:String=null) {			this.room = room;			setGround(5,3,0,"Dude12:H@G2,-3");//			setGround(-1,4,0,":M@N");//			setGround(-1,4,0,":M@S");
//			setGround(-1,4,0,":M@E");
//			setGround(-1,4,0,":M@W");
//			setWall("#|-1|3|N","davinci.swf");//			setWall("#|-1|3|W","davinci.swf");			setWall("#|-1|3|N","ut.swf|SHEwFoo_KA0|Le Petit Train");//			setWall("#|1|-8|E","ut.swf|Xqolbz8B4M8|Soiree Disco");			setWall("#|3|-6|N","ut.swf|GjKaCu6ZlV8|Tes Yeux Noirs");			setWall("#|-1|-12|S","ut.swf|sSeu0jmF-oA|Ridin'");			setWall("#|-8|-13|N","ut.swf|P86fPsC_cCQ|Ecuador");			setWall("#|-6|-19|N","ut.swf|L3L59fu8ZFY|Adelaide");			setWall("#|3|-13|E","ut.swf|7syauAfRtRA|Muteking");			setWall("#|1|9|E","ut.swf|JjTV8i_KjXM|Castle in the sky");			/*			setGround(-2,-7,0,"VideoTestingSign:H@G0,0");			setWall("#|-1|-9|W","ut.swf|sSeu0jmF-oA");			setWall("#|0|-7|N","ut.swf|8WmeD8A-pa4");			setWall("#|1|-8|E","ut.swf|Xqolbz8B4M8");			setWall("#|-3|-8|N","ut.swf|SHEwFoo_KA0");			setWall("#|-8|-13|N","ut.swf|P86fPsC_cCQ");			setWall("#|-6|-19|N","ut.swf|-Lp0PObGtAs");			setWall("#|0|-10|S","ut.swf|7syauAfRtRA");			setWall("#|1|-9|E","ut.swf|JjTV8i_KjXM");			setWall("#|2|7|S","canvas.swf|http://2012hoax.wdfiles.com/local--files/einstein/albert-einstein1.jpg|EINSTEIN");			setWall("#|26|0|N","ut.swf|x7hbPFc313Y");			setWall("#|2|9|N","canvas.swf|http://www.teachnet.ie/fwilliams/2006/images/Gandhi1.jpg|GANDHI");			setWall("#|-25|-6|S","door.swf|http://www.newgrounds.com/|http://thornesattic.com/images/Newgrounds-256x256.png|NEWGROUNDS");			setWall("#|-25|-3|N","door.swf|http://www.ytmnd.com/|http://www.schwimmerlegal.com/YTMND.jpg|YTMND");			/*/			//setWall("#|2|9|N","canvas.swf|http://www.teachnet.ie/fwilliams/2006/images/Gandhi1.jpg|GANDHI");			//setWall("#|-25|-6|S","door.swf|http://www.newgrounds.com/|http://thornesattic.com/images/Newgrounds-256x256.png|NEWGROUNDS");			//setWall("#|-25|-3|N","door.swf|http://www.ytmnd.com/|http://www.schwimmerlegal.com/YTMND.jpg|YTMND");			//*///			setWall("#|2|0|N","comment.swf|Keyboard Controls:\n\nForward\nW\n\nBackward\nS\n\nTurn Left\nQ\n\nTurn Right\nE\n\nMove Left\nA\n\nMove Right\nD\n\nApproach\nSpace");//			setWall("ut.swf|sSeu0jmF-oA");//								if(ggid=="#|-1|3|N") {/*								else if(ggid=="#|0|-10|S"||ggid=="#|1|-9|E") {									cell[7]="loadwall";									cell[8]="ut.swf";									cell[9]=ggid=="#|0|-10|S"?"7syauAfRtRA":"JjTV8i_KjXM";									cell[10]="constantrefresh";									//cell[10]="Chatworld Beta v.1";									//cell[11]="chatworld.swf";								}*/		}				override public function hasGround(px:int,py:int,ph:int):Boolean {			var id:String = px+"|"+py+"|"+ph;			if(id in grounds)				return getGround(px,py,ph) && getGroundObjects(px,py,ph).G;//			if(super.hasGround(px,py,ph))//				return true;			var mt:int = (px^py)+1;//^(hi+hpos);//			return !mt||Math.abs(Math.abs(mt))%13;			return Boolean((Math.abs(mt)%3)||!(Math.abs(mt)%7)||!(Math.abs(mt)%13)||!(Math.abs(mt)%1978));		}				override public function getMap(xpos:int,ypos:int,hpos:int,idir:int,approach,mode:int):Array {			var array:Array = [];						var xd:int, yd:int, xyd:int, yxd:int;			switch(idir) {				case 0: xd=1;yd=1;xyd=0;yxd=0;break;				case 1: xd=0;yd=0;xyd=1;yxd=-1; break;				case 2: xd=-1;yd=-1;xyd=0;yxd=0; break;				case 3: xd=0;yd=0;xyd=-1;yxd=1; break;			}			var ylimit:int = approach?0:3+(mode==1?1:0);			var SIDE4:Array = [['L',new Point(-1,0)],['R',new Point(1,0)],['F',new Point(0,-1)],['B',new Point(0,1)]];						var missinginfo:Array = [];			for(var yi=approach||mode==2?-1:0;yi<=ylimit;yi++) {				var xlimit:int = approach?0:2+Math.max(0,yi*2)+(mode==2?3:0);				for(var xi=-xlimit;xi<=xlimit;xi++) {					var px:int = xi*xd+yi*xyd+xpos;					var py:int = yi*yd+xi*yxd+ypos;					var ph:int = hpos;					var gid:String = ["#",px,py].join("|");										if(hasGround(px,py,ph)) {						//var id:String = px+"|"+py+"|"+ph;						//if(!(id in pos)) {							//pos[id] = 1;							//missinginfo.push(gid);						//}												array.push([xi,yi,-1,'D',['D',xi,yi,-1].join("|"),gid+"|F","Block"]);						var ixp, iyp, xxp, yyp;						//if(mode==1)							//array.push([xi,yi, 1,'U',['U',xi,yi, 1].join("|"),gid+"|C","Block"]);						if(px==1&&py==1) {							ixp = 1-xpos;							iyp = 1-ypos;							xxp = ixp*xd-iyp*xyd;							yyp = iyp*yd-ixp*yxd-.5;							//trace(xxp,yyp);//[type,xi,yi].join(",")							//array.push([xxp,yyp,0,null,"smurfy","smurfy","SmurfBMP"]);							array.push([xxp,yyp,0,null,"jopi.swf",gid+"|"+"jopi.swf","jopi.swf","load"]);						}						else if(px==5&&py==3) {							ixp = 4.8-xpos;//+getTimer()/10000;							//trace(getTimer()/1000);							iyp = 2.2-ypos;							xxp = ixp*xd-iyp*xyd;							yyp = iyp*yd-ixp*yxd-.5;							array.push([xxp,yyp,0,null,gid+"|d13",gid+"|"+"d13","Dude13","unique"]);//							array.push([xxp,yyp,0,null,"smurfy",gid+"|"+"smurfy","SmurfBMP","unique"]);//							trace([xxp,yyp,0,null,gid+"|d13",gid+"|"+"d13","Dude13","unique"]);						}						else if(px==2009&&py==3540) {//							trace("here");							ixp = 9.2-xpos;//+getTimer()/10000;							iyp = 14.2-ypos;							xxp = ixp*xd-iyp*xyd;							yyp = iyp*yd-ixp*yxd-.5;//							array.push([xxp,yyp,0,null,"smurfy",gid+"|"+"smurfy","SmurfBMP","unique"]);//							array.push([xxp,yyp,0,null,"smurfy","smurfy","SmurfBMP"]);							//array.push([xxp,yyp,0,null,"pixoo",gid+"|"+"pixoo","Pixoo"]);												}					}					else {						///*						for(var i=0;i<SIDE4.length;i++) {							//if(approach&&i!=2)								//continude;														if(i<2 || yi>=0) {								var s4 = SIDE4[i];								var xp:Number = xi+s4[1].x*.5;								var yp:Number = yi+s4[1].y*.5-(i<2?0:.5);								var sid:String = [s4[0],xp,yp,0].join("|");								var ggid:String = gid+"|"+transcode(xd,yd,xyd,yxd,s4[1].x,s4[1].y);								var cell:Array = [xp,yp,0,s4[0],sid,ggid,i<2?"Block":"FrontWall"];								if(!(ggid in walls)) {									missinginfo.push(ggid);								}								else if(walls[ggid]) {									cell[7] = "loadwall";									cell = cell.concat(walls[ggid].split("|"));								}								else if(ggid=="#|-1|3|N") {									cell[7]="loadwall";									cell[8]="graph.swf";									if(!securedomains[cell[8]]) {										securedomains[cell[8]] = true;										Security.allowDomain(cell[8]);									}								}								array.push(cell);							}						}						/*/						array.push([xi-.5,yi,0,'L',['L',xi-.5,yi,0].join("|"),gid+"|"+transcode(xd,yd,xyd,yxd,-1,0),"Block"]);						array.push([xi+.5,yi,0,'R',['R',xi+.5,yi,0].join("|"),gid+"|"+transcode(xd,yd,xyd,yxd,1,0),"Block"]);						if(yi>=0) {							array.push([xi,yi,0,'B',['B',xi,yi,0].join("|"),gid+"|"+transcode(xd,yd,xyd,yxd,0,1),"FrontWall"]);							array.push([xi,yi-1,0,'F',['F',xi,yi-1,0].join("|"),gid+"|"+transcode(xd,yd,xyd,yxd,0,-1),"FrontWall"]);						}						//*/					}					var objs = getGroundObjects(px,py,ph);					if(objs) {						for(var o in objs) {							var list = objs[o];							for(i=0;i<list.length;i++) {								var l = list[i];								ixp = px-xpos + (l[1]?parseInt(l[1])/10:0);//4.8-xpos;								iyp = py-ypos + (l[2]?parseInt(l[2])/10:0);//2.2-ypos;								xxp = ixp*xd-iyp*xyd;								yyp = iyp*yd-ixp*yxd-.5;								array.push([xxp,yyp,0,null,gid+"|"+l[0],gid+"|"+l[0],l[0],"unique"]);//w								trace(gid,l[0],xxp,yyp);//									trace([xxp,yyp,0,null,gid+"|d12"+l[0],gid+"|d13"+l[0],l[0],"unique"]);							}						}					}				}			}			//			if(missinginfo.length && loadInformation(missinginfo)) {//				missinginfo.forEach(function(elem:*,index:Number,array:Array) { walls[elem]=null; });//			}//			trace(array);			//trace(missinginfo);			return array;		}				public var comdevice:String = null;		var mixi = 0;		var infoloader:URLLoader = null;		function loadInformation(array:Array):Boolean {			if(!infoloader) {				infoloader = new URLLoader();				var urlrequest:URLRequest = new URLRequest(comdevice?comdevice:"http://hamster.agilityhoster.com/mixo.php");				urlrequest.data = new URLVariables();				urlrequest.data.mixi = mixi;				urlrequest.data.update = "ab";				if(room)					urlrequest.data.r = room;				urlrequest.data.q = array.join(",");//				for(var i=0;i<array.length;i++) {//					urlrequest.data["f["+array[i]+"]"]="";//				}				infoloader.addEventListener(Event.COMPLETE,					function(e) {						//trace(urlrequest.url,urlrequest.data);						//trace(">"+e.currentTarget.data+"<");//						trace(e.currentTarget.data,urlrequest.data);						if(e.currentTarget.data!="") {							try {								var json = JSON.parse(e.currentTarget.data); //JSON.decode(e.currentTarget.data);								//trace(">>",e.currentTarget.data);								if(json.mixi)									mixi = json.mixi;								if(json.data) {									for(var i in json.data) {										var d = json.data[i];										if (d is Array)											d = d[d.length-1];										setWall(i,d);									}								}							}							catch(error) {							}							//trace(JSON.encode(json));						}						infoloader = null;					});				infoloader.addEventListener(IOErrorEvent.IO_ERROR,					function(e) {//						trace(e);//						trace(e.currentTarget						array.forEach(function(elem:*,index:Number,array:Array) 							{ if(walls[elem]===null) delete walls[elem]; });						infoloader = null;					});				//trace(urlrequest.data);				infoloader.load(urlrequest);				return true;			}			return false;		}	}}